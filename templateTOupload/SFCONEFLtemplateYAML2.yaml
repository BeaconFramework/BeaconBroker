heat_template_version: 2014-10-16

description: 

outputs:
  out_A_private_ip:
    description:  IP address server in private network
    value:
      get_attr:
        - A
        - first_address
  out_B_private_ip:
    description: IP address of B server in private network
    value:
      get_attr:
        - B
        - first_address
 
parameters:
  flavor:
    constraints:
      -
        allowed_values:
          - m1.tinyCM
          - m1.smallCM
          - m1.mediumCM
        description: must be a valid CloudWave Server flavor.
    default: m1.smallCM
    description: Flavor to use for servers
    type: string
  image-A:
    type: string
    description: description
    default: cirros-0.3.4-x86_64-uec
  image-B:
    type: string
    description: description
    default: cirros-0.3.4-x86_64-uec
  cirros:
    type: string
    description: description
    default: cirros-0.3.4-x86_64-uec            
  key_name:
    default: heat_key
    description: Name of keypair to assign to servers
    type: string
  private_network:
    type: string
    label: Private network name or ID
    description: Network to attach instance to.
    default: private
  public_network:
    type: string
    label: Public network name or ID
    description: Network to attach instance to.
    default: external

resources:
  geoshape_1:
    type: OS::Beacon::Georeferenced_deploy
    properties:
      label: Shape label
      description: descripition
      shapes: [{"type":"Feature","id":"ITA","properties":{"name":"Italy"},"geometry":{"type":"MultiPolygon","coordinates":[[[[15.520376,38.231155],[15.160243,37.444046],[15.309898,37.134219],[15.099988,36.619987],[14.335229,36.996631],[13.826733,37.104531],[12.431004,37.61295],[12.570944,38.126381],[13.741156,38.034966],[14.761249,38.143874],[15.520376,38.231155]]],[[[9.210012,41.209991],[9.809975,40.500009],[9.669519,39.177376],[9.214818,39.240473],[8.806936,38.906618],[8.428302,39.171847],[8.388253,40.378311],[8.159998,40.950007],[8.709991,40.899984],[9.210012,41.209991]]],[[[12.376485,46.767559],[13.806475,46.509306],[13.69811,46.016778],[13.93763,45.591016],[13.141606,45.736692],[12.328581,45.381778],[12.383875,44.885374],[12.261453,44.600482],[12.589237,44.091366],[13.526906,43.587727],[14.029821,42.761008],[15.14257,41.95514],[15.926191,41.961315],[16.169897,41.740295],[15.889346,41.541082],[16.785002,41.179606],[17.519169,40.877143],[18.376687,40.355625],[18.480247,40.168866],[18.293385,39.810774],[17.73838,40.277671],[16.869596,40.442235],[16.448743,39.795401],[17.17149,39.4247],[17.052841,38.902871],[16.635088,38.843572],[16.100961,37.985899],[15.684087,37.908849],[15.687963,38.214593],[15.891981,38.750942],[16.109332,38.964547],[15.718814,39.544072],[15.413613,40.048357],[14.998496,40.172949],[14.703268,40.60455],[14.060672,40.786348],[13.627985,41.188287],[12.888082,41.25309],[12.106683,41.704535],[11.191906,42.355425],[10.511948,42.931463],[10.200029,43.920007],[9.702488,44.036279],[8.888946,44.366336],[8.428561,44.231228],[7.850767,43.767148],[7.435185,43.693845],[7.549596,44.127901],[7.007562,44.254767],[6.749955,45.028518],[7.096652,45.333099],[6.802355,45.70858],[6.843593,45.991147],[7.273851,45.776948],[7.755992,45.82449],[8.31663,46.163642],[8.489952,46.005151],[8.966306,46.036932],[9.182882,46.440215],[9.922837,46.314899],[10.363378,46.483571],[10.442701,46.893546],[11.048556,46.751359],[11.164828,46.941579],[12.153088,47.115393],[12.376485,46.767559]]]]}}]

  geoshape_2:
    type: OS::Beacon::Georeferenced_deploy
    properties:
      label: Shape label
      description: descripition
      shapes: [{"type":"Feature","id":"BEL","properties":{"name":"Belgium"},"geometry":{"type":"Polygon","coordinates":[[[3.314971,51.345781],[4.047071,51.267259],[4.973991,51.475024],[5.606976,51.037298],[6.156658,50.803721],[6.043073,50.128052],[5.782417,50.090328],[5.674052,49.529484],[4.799222,49.985373],[4.286023,49.907497],[3.588184,50.378992],[3.123252,50.780363],[2.658422,50.796848],[2.513573,51.148506],[3.314971,51.345781]]]}},{"type":"Feature","id":"ITA","properties":{"name":"Italy"},"geometry":{"type":"MultiPolygon","coordinates":[[[[15.520376,38.231155],[15.160243,37.444046],[15.309898,37.134219],[15.099988,36.619987],[14.335229,36.996631],[13.826733,37.104531],[12.431004,37.61295],[12.570944,38.126381],[13.741156,38.034966],[14.761249,38.143874],[15.520376,38.231155]]],[[[9.210012,41.209991],[9.809975,40.500009],[9.669519,39.177376],[9.214818,39.240473],[8.806936,38.906618],[8.428302,39.171847],[8.388253,40.378311],[8.159998,40.950007],[8.709991,40.899984],[9.210012,41.209991]]],[[[12.376485,46.767559],[13.806475,46.509306],[13.69811,46.016778],[13.93763,45.591016],[13.141606,45.736692],[12.328581,45.381778],[12.383875,44.885374],[12.261453,44.600482],[12.589237,44.091366],[13.526906,43.587727],[14.029821,42.761008],[15.14257,41.95514],[15.926191,41.961315],[16.169897,41.740295],[15.889346,41.541082],[16.785002,41.179606],[17.519169,40.877143],[18.376687,40.355625],[18.480247,40.168866],[18.293385,39.810774],[17.73838,40.277671],[16.869596,40.442235],[16.448743,39.795401],[17.17149,39.4247],[17.052841,38.902871],[16.635088,38.843572],[16.100961,37.985899],[15.684087,37.908849],[15.687963,38.214593],[15.891981,38.750942],[16.109332,38.964547],[15.718814,39.544072],[15.413613,40.048357],[14.998496,40.172949],[14.703268,40.60455],[14.060672,40.786348],[13.627985,41.188287],[12.888082,41.25309],[12.106683,41.704535],[11.191906,42.355425],[10.511948,42.931463],[10.200029,43.920007],[9.702488,44.036279],[8.888946,44.366336],[8.428561,44.231228],[7.850767,43.767148],[7.435185,43.693845],[7.549596,44.127901],[7.007562,44.254767],[6.749955,45.028518],[7.096652,45.333099],[6.802355,45.70858],[6.843593,45.991147],[7.273851,45.776948],[7.755992,45.82449],[8.31663,46.163642],[8.489952,46.005151],[8.966306,46.036932],[9.182882,46.440215],[9.922837,46.314899],[10.363378,46.483571],[10.442701,46.893546],[11.048556,46.751359],[11.164828,46.941579],[12.153088,47.115393],[12.376485,46.767559]]]]}}]

  association_ip_A:
    type: OS::Neutron::FloatingIPAssociation
    properties:
      floatingip_id: {get_resource: A_floating_ip}
      port_id: {get_attr: [A, addresses, {get_param: private_network}, 0, port]}

  A_floating_ip:
    type: OS::Neutron::FloatingIP
    properties:
      floating_network: { get_param: public_network }

  A:
    type: OS::Nova::Server
    properties:
      name: VM-A
      metadata: {'cloudwave-migrate': 'true'}
      key_name: { get_param: key_name }
      image: { get_param: image-A }
      flavor: { get_param: flavor }
      networks: [{"fixed_ip": 10.0.0.61, "network": { get_param: private_network } }]
      security_groups:  [{ get_resource: server_security_group }]
      user_data: |
          #!/bin/bash
          echo root:vagrant | chpasswd
          sudo apt-get update

  association_ip_B:
    type: OS::Neutron::FloatingIPAssociation
    properties:
      floatingip_id: {get_resource: B_floating_ip}
      port_id: {get_attr: [B, addresses, {get_param: private_network}, 0, port]}

  B_floating_ip:
    type: OS::Neutron::FloatingIP
    properties:
      floating_network: { get_param: public_network }

  B:
    type: OS::Nova::Server
    properties:
      name: test
      key_name: {get_param: key_name }
      image: {get_param: cirros }
      flavor: m1.tiny

  server_security_group:
    properties:
      description: Standard firewall rules
      name: SEC_GR_Name
      rules:
      - direction: egress
        ethertype: IPv6
      - direction: ingress
        ethertype: IPv6
        remote_mode: remote_group_id
      - direction: ingress
        ethertype: IPv4
        port_range_max: 22
        port_range_min: 22
        protocol: tcp
        remote_ip_prefix: 0.0.0.0/0
      - direction: egress
        ethertype: IPv4
      - direction: ingress
        ethertype: IPv4
        remote_mode: remote_group_id
      - direction: ingress
        ethertype: IPv4
        port_range_max: 5060
        port_range_min: 5060
        protocol: tcp
        remote_ip_prefix: 0.0.0.0/0
      - protocol: icmp
    type: OS::Neutron::SecurityGroup

  federation:
    type: OS::Beacon::ServiceGroupManagement
    properties:
      name: GroupName
      geo_deploy: { get_resource: geoshape_2}
      resource:
        groups:  {get_resource: [ B, A] }    

  federation2:
    type: OS::Beacon::ServiceGroupManagement
    properties:
      name: GroupName
      geo_deploy: { get_resource: geoshape_1}
      resource:
        groups:  {get_resource: B}
               
  fedNetworklink:
    type: OS::Beacon::fedNetManagement
    properties:
      monitored_Group: stateless_VM
      connected_VM: 
        - res_1_name
        - res_2_name

  fedSecGroup:
    type: OS::Beacon::fedSecManagement
    properties: 
      monitored_resource:
        - federation
        - res_1_name
      fw_rules: [{ get_resource: server_security_group }]
      policies: [{ get_resource: xacml_security_group }]

  xacml_security_group:
    type:  OS::Beacon::PoliciesAccManagement
    properties:
      rules:
        - value 

  vnfsfcglobalResource:
    type: TOSCA::Beacon::vnf_sfc_manifests
    properties:
      geo_deploy: { get_resource: geoshape_2}
      vnfd_version: version_____
      vnfd_description: description
      vnfd_templatename: template_name
      vnffg_version: version_____
      vnffg_description: description
      vnffg_toplogy_template_description: description
      resource: 
        innerres: {get_resource : [ VDU1,CP1,VL1,Forwarding_path1,VNFFG1]}
  
  VDU1:
    type: tosca.nodes.nfv.VDU.Tacker
    capabilities:
      nfv_compute:
        properties:
          num_cpus: 1
          mem_size: 512 MB
          disk_size: 1 GB
    properties:
      image: cirros-0.3.5-x86_64-disk
      availability_zone: nova
      mgmt_driver: noop
      config: |
        param0: key1
        param1: key2
  
  CP1:
    type: tosca.nodes.nfv.CP.Tacker
    properties:
      management: true
      order: 0
      anti_spoofing_protection: false
    requirements:
      - virtualLink:
          node: VL1
      - virtualBinding:
          node: VDU1
          
  VL1:
    type: tosca.nodes.nfv.VL
    properties:
      network_name: net_mgmt
      vendor: Tacker
      
  Forwarding_path1:
    type: tosca.nodes.nfv.FP.Tacker
    description: creates path (CP12->CP22)
    properties:
      id: 51
      policy:
        type: ACL
        criteria:
          - network_src_port_id: 640dfd77-c92b-45a3-b8fc-22712de480e1
          - destination_port_range: 80-1024
          - ip_proto: 6
          - ip_dst_prefix: 192.168.1.2/24
      path:
        - forwarder: VNFD1
          capability: CP12
        - forwarder: VNFD2
          capability: CP22

  VNFFG1:
    type: tosca.groups.nfv.VNFFG
    description: HTTP to Corporate Net
    properties:
      vendor: tacker
      version: 1.0
      number_of_endpoints: 5
      dependent_virtual_link: [VL12,VL22]
      connection_point: [CP12,CP22]
      constituent_vnfs: [VNFD1,VNFD2]
    members: [Forwarding_path1]
      
  prova:
    type:  ONE::Beacon::OneFlowTemplate
    properties:
        name: GroupName
        geo_deploy: { get_resource: geoshape_1}
        onetemplate: {"name": "Scalability1","deployment": "none","roles": [ { "name": "frontend","cardinality": 2,"vm_template": 0,"min_vms" : 1,"max_vms" : 5,"elasticity_policies" : [ {              "expression": "ATT > 50","type" : "CHANGE","adjust" : 2,"period_number" : 3,"period" : 10},{"expression" : "ATT < 20","type" : "PERCENTAGE_CHANGE","adjust" : -10,"min_adjust_step" : 2}]}]}
        